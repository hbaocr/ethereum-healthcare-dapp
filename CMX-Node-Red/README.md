### Overview
This Flow is an example of how to use the Meraki CMX JSON feed to store clients into a database, track deivces on a Google map and send a notification to chat room.


There are five major components:
- CMX Receiver
- Front-end API
- Front-end Website (Google MAP)
- MongoDB (Tracking List)
- Cisco Spark room

Pre-requisities:

Install Homebrew:
```sh
ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"
```
Install node.js and npm: 
```sh
brew install node
```
Install Node-RED:
```sh
sudo npm install -g node-red
```
Setup Meraki:
Meraki: https://account.meraki.com/secure/login/dashboard_login


### CMX Receiver
There are 4 types of CMX data can be feeded into the flow:
- Sample CMX data
- Meraki CMX Location and scanning data
- Meraki CMX Dashboard API
- Cisco Prod CMX API

There are two Sample Clients data that can be used to test the flow:

The CMX Listener utilizes the Node-RED CMX node to collect JSON data from a Meraki network. This feed is generally updated within 2 minutes. 

Once the data has been received, the JSON is parsed and committed to a MongoDB. Please ensure your MongoDB is running for this flow to work properly.

Using Ngrok if your Node-Red is behind a NAT or firewall.

## Front-end API - 
There are two [GET] HTTP routes that provide access to the collected client data. These will be used by the front-end website to pull the client information for all or specific clients. Fun Fact: You can also use these routes with Postman or a standard browser to pull the data directly.

## Front-end Website - 
This will provide the webpage to view the Google map and track clients.
The website can be viewed at
`http://yourserver:1880/cmxapimap`

## Cisco Spark room -
The flow will parses the CMX data and posts the matching clients into a Cisco Spark room.


# Pre-requisities

CMX receiver node: https://flows.nodered.org/node/node-red-contrib-meraki-cmx
Spark node: https://flows.nodered.org/node/node-red-contrib-spark
Https node: https://flows.nodered.org/node/node-red-contrib-https
Mongodb2 node: https://flows.nodered.org/node/node-red-contrib-mongodb2
Objectid node: https://flows.nodered.org/node/node-red-contrib-objectid


# Setup

- Paste the source code below into Node-Red Clipboard.

- Configure a Cisco Meraki network to post the CMX JSON to your listening URL. Example: `http://yourserver:1880/cmx`

- The Meraki Dashboard must be configured to point to your Node-RED service.
http://www.internetoflego.com/wifi-location-based-analytics-workflows-cisco-meraki-cmx/

- Install and configure MongoDB. Then update the MongoDB2 nodes within your flow to match the appropriate settings.
Example: `mongodb://localhost:27017/test`

- Configure the Spark node by changing the bearer token and room ID.
https://developer.ciscospark.com/endpoint-webhooks-post.html

- Insert Sample Client information by pressing the blue buttons for each. 


### Source Code:
```sh
[{"id":"76e79b6.be1e864","type":"tab","label":"Flow 1"},{"id":"3ca0454e.b9d84a","type":"debug","z":"76e79b6.be1e864","name":"No match","active":true,"console":"false","complete":"true","x":2410,"y":963,"wires":[]},{"id":"248be9f8.926226","type":"debug","z":"76e79b6.be1e864","name":"Raw CMX Data","active":true,"console":"false","complete":"true","x":1943.5000305175781,"y":959.5000143051147,"wires":[]},{"id":"e562bffe.63bdb","type":"debug","z":"76e79b6.be1e864","name":"Spark POST debug","active":true,"console":"false","complete":"true","x":2944.428565979004,"y":970.0000143051147,"wires":[]},{"id":"8fecf220.a0fff","type":"switch","z":"76e79b6.be1e864","name":"MAC address match","property":"payload","propertyType":"msg","rules":[{"t":"cont","v":"Apple","vt":"str"},{"t":"else"}],"checkall":"false","outputs":2,"x":2196,"y":893,"wires":[["e05b5d6c.ea078"],["1728aba8.bfb864"]]},{"id":"5e20699c.2cf488","type":"json","z":"76e79b6.be1e864","name":"","x":2009,"y":893,"wires":[["8fecf220.a0fff"]]},{"id":"e05b5d6c.ea078","type":"json","z":"76e79b6.be1e864","name":"","x":2382,"y":887,"wires":[["dc80373.48913c8"]]},{"id":"623f4dca.d84d34","type":"debug","z":"76e79b6.be1e864","name":"Spark API Data","active":true,"console":"false","complete":"true","x":2695.714286804199,"y":964.4285755157471,"wires":[]},{"id":"ee76a8a4.fe9fb8","type":"function","z":"76e79b6.be1e864","name":"Spark API call","func":"// This function creates HTTP GET parameters\n// for sending to the Meraki Dashboard\nmap = msg.payload;\napi_key = '75830a61e677a3ef90667865fcc2ab9f7bb92616';\ndashboard_header = {\n        'x-cisco-meraki-api-key': api_key,\n        'Content-Type': 'application/json'\n};\n\nmsg.headers = dashboard_header;\nmsg.payload = '';\nreturn msg;\n","outputs":1,"noerr":0,"x":2090,"y":1088.5,"wires":[["5185966c.2c5118","5ddead9c.74ce24"]]},{"id":"5ddead9c.74ce24","type":"http request","z":"76e79b6.be1e864","name":"Dashboard GET","method":"GET","ret":"obj","url":"https://dashboard.meraki.com/api/v0/networks/N_664280945037184994/sm/devices?fields=location","tls":"","x":2301.5,"y":1088.5,"wires":[["87693946.e6e198","aa06ff00.f3752"]]},{"id":"87693946.e6e198","type":"debug","z":"76e79b6.be1e864","name":"Dashboard Response","active":true,"console":"false","complete":"payload","x":2559,"y":1170.5,"wires":[]},{"id":"aa06ff00.f3752","type":"function","z":"76e79b6.be1e864","name":"Find device name by mac","func":"// This function parses the Meraki Dashboard API response\n// and creates a message to POST to a Spark room.\n// Fill in the roomId & bot_token with your own details\nclient = {}; //reset payload object for clarity\nclient.roomId = 'Y2lzY29zcGFyazovL3VzL1JPT00vNWFkODNlMzAtMDJhNS0xMWU3LWE2YzYtYjljMzEwNjkxM2I0';\nmap = msg.payload;\nmsg.payload = {};\nvar o = map['devices'];\n for (var c in o){\n if (o.hasOwnProperty(c)) {\n if (o[c]['name'] === \"YINQWU-CPDFF\"){\n  clientName = o[c]['name'];\n  osName = o[c]['osName'];\n  systemModel = o[c]['systemModel'];\n  location = o[c]['location'];\n  client.text = 'Client: ' + clientName + ' with Device ' + systemModel + ' ' + osName +' was found around ' + location;\n        //  o[c]['clientMac'];\n        // o[c]['location']['lat'];\n        // o[c]['location']['lng'];\n        // o[c]['location']['unc'];\n        // o[c]['seenEpoch'];\n        // map['data']['apFloors'] === null ? \"\" : map['data']['apFloors'].join;\n        // o[c]['manufacturer'];\n        // o[c]['os'];\n        // o[c]['ssid'];\n     \n     \n     \n }\n }\n}\n// for (var key in result) {\n//   if (result.hasOwnProperty(key)) {\n//     var dev_mac = result[key].mac;\n//     if (dev_mac === ap_mac) {\n//       var dev_name = result[key].name;\n//       client.text = 'Device name: ' + dev_name;\n//   }\n//  }\n// }\nmsg.payload.body = client;\nreturn msg;","outputs":1,"noerr":0,"x":2529,"y":1088.5,"wires":[["48b2ab43.d55534","d0205ef6.cb3ae"]]},{"id":"5185966c.2c5118","type":"debug","z":"76e79b6.be1e864","name":"Dashboard GET params","active":true,"console":"false","complete":"true","x":2273,"y":1168.5,"wires":[]},{"id":"48b2ab43.d55534","type":"debug","z":"76e79b6.be1e864","name":"Find Client ","active":true,"console":"false","complete":"true","x":2788,"y":1169.5,"wires":[]},{"id":"918b98ac.319928","type":"Spark API","z":"76e79b6.be1e864","profileConfig":"fdebfc7f.8c18f","apiUrl":"http://127.0.0.1:1880/api/cisco_spark_v1.json","resource":"Messages","method":"createMessage","name":"post cmx details","x":2745.428565979004,"y":887.0000143051147,"wires":[["e562bffe.63bdb"]]},{"id":"d0205ef6.cb3ae","type":"Spark API","z":"76e79b6.be1e864","profileConfig":"fdebfc7f.8c18f","apiUrl":"http://127.0.0.1:1880/api/cisco_spark_v1.json","resource":"Messages","method":"createMessage","name":"post device name","x":2765.5,"y":1088.5,"wires":[["5b8d6cc4.22d474"]]},{"id":"5b8d6cc4.22d474","type":"debug","z":"76e79b6.be1e864","name":"POST name","active":true,"console":"false","complete":"true","x":2993,"y":1171.5,"wires":[]},{"id":"898b17f7.501808","type":"Meraki CMX","z":"76e79b6.be1e864","name":"CMX listener","url":"/cmx","settings":"21825d46.ffa242","x":1836.5,"y":893,"wires":[["5e20699c.2cf488","248be9f8.926226","18656189.fe115e"]]},{"id":"1728aba8.bfb864","type":"json","z":"76e79b6.be1e864","name":"","x":2249.5000343322754,"y":962.5000133514404,"wires":[["3ca0454e.b9d84a"]]},{"id":"e9ba9eb7.3f885","type":"inject","z":"76e79b6.be1e864","name":"Meraki CMX API call","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":1878.5,"y":1088.5,"wires":[["ee76a8a4.fe9fb8"]]},{"id":"dc80373.48913c8","type":"function","z":"76e79b6.be1e864","name":"Spark API Input","func":"map = msg.payload;\nclient = {}; //reset payload object for clarity\nclient.roomId = 'Y2lzY29zcGFyazovL3VzL1JPT00vNWFkODNlMzAtMDJhNS0xMWU3LWE2YzYtYjljMzEwNjkxM2I0';\nclient.text='';\nclient.timestamp = new Date();\nvar dt = client.timestamp;\nvar year    = dt.getFullYear();\nvar month = dt.getMonth() - 1;\nvar day = dt.getDate();\nvar hour    = dt.getHours();\nvar minute  = dt.getMinutes();\nvar second  = dt.getSeconds(); \n\nif(month.toString().length == 1) {\nvar month = '0'+month;\n}\nif(day.toString().length == 1) {\nvar day = '0'+day;\n}   \nif(hour.toString().length == 1) {\nvar hour = '0'+hour;\n}\nif(minute.toString().length == 1) {\nvar minute = '0'+minute;\n}\nif(second.toString().length == 1) {\nvar second = '0'+second;\n}   \n\nclient.timeWindow = year+month+day+hour+minute+second;\n\n\nif (map['version'] != '2.0'){\n msg.log = \"got post with unexpected version: #{map['version']}\";\n return msg;\n}else{\n msg.log = \"working with correct version\";\n}\nif (map['type'] != 'DevicesSeen'){\nmsg.log = \"got post for event that we're not interested in: #{map['type']}\";\nclient.text ='no new devices was found';\nreturn msg;\n}\nvar o = map['data']['observations'];\nconsole.log('map.data.apMac = '+map.data['apMac']);\n for (var c in o){\n if (o.hasOwnProperty(c)) {\n if (!o[c]['location']){continue}\n console.log('map.data.observations.clientMac = '+o[c]['clientMac']);\n\n var ts = new Date(o[c]['seenTime']);\n var year    = ts.getFullYear();\n var month = ts.getMonth();\n var day = ts.getDate();\n var hour    = ts.getHours();\n var minute  = ts.getMinutes();\n var second  = ts.getSeconds(); \n\n if(month.toString().length == 1) {\n var month = '0'+month;\n }\n if(day.toString().length == 1) {\n var day = '0'+day;\n }   \n if(hour.toString().length == 1) {\n var hour = '0'+hour;\n }\n if(minute.toString().length == 1) {\n var minute = '0'+minute;\n }\n if(second.toString().length == 1) {\n var second = '0'+second;\n }   \n sTime = year+month+day+hour+minute+second;\n client.seenTime= sTime;\n \n if (sTime > client.timeWindow){\n  clientMac = o[c]['clientMac'];\n  apMac = map.data['apMac'];\n  lat = o[c]['location']['lat'];\n  lng = o[c]['location']['lng'];\n  seenTime = o[c]['seenTime'];\n  client.text = 'Client: ' + clientMac + ' was detected by AP ' + apMac + '. Client  ' + clientMac +' was found around ' + lat + ',' +  lng + ' at ' + seenTime;\n        //  o[c]['clientMac'];\n        // o[c]['location']['lat'];\n        // o[c]['location']['lng'];\n        // o[c]['location']['unc'];\n        // o[c]['seenEpoch'];\n        // map['data']['apFloors'] === null ? \"\" : map['data']['apFloors'].join;\n        // o[c]['manufacturer'];\n        // o[c]['os'];\n        // o[c]['ssid'];\n }\n }\n}\nmsg.payload.body = client;\nreturn msg;","outputs":"1","noerr":0,"x":2541.5,"y":887,"wires":[["918b98ac.319928","623f4dca.d84d34"]]},{"id":"4fcc10.bb18c3f","type":"https-node","z":"76e79b6.be1e864","name":"Https GET Request","method":"GET","ret":"obj","url":"https://cmx-mtv1-1-a.cisco.com/api/location/v2/clients","authorized":false,"agent":true,"x":2077.499966621399,"y":1288.0000667572021,"wires":[["f5162554.28f438","eb4d6c47.515aa"]]},{"id":"a6555d8.6f65ca","type":"inject","z":"76e79b6.be1e864","name":"MTV CMX API Call","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":1861.4999694824219,"y":1288.0001220703125,"wires":[["4fcc10.bb18c3f"]]},{"id":"eb4d6c47.515aa","type":"function","z":"76e79b6.be1e864","name":"Find device name by mac","func":"// This function parses the Meraki Dashboard API response\n// and creates a message to POST to a Spark room.\n// Fill in the roomId & bot_token with your own details\nclient = {}; //reset payload object for clarity\nclient.roomId = 'Y2lzY29zcGFyazovL3VzL1JPT00vNWFkODNlMzAtMDJhNS0xMWU3LWE2YzYtYjljMzEwNjkxM2I0';\nmap = msg.payload;\nmsg.payload = {};\nvar o = map;\n for (var c in o){\n if (o.hasOwnProperty(c)) {\n if (o[c]['name'] === \"YINQWU-CPDFF\"){\n  clientName = \"YINQWU-CPDFF\";\n  clientMac = o[c]['macAddress'];\n  clientFloor = o[c]['mapInfo']['mapHierarchyString'];\n  client.text = 'Client: ' + clientName + ' with Device ' + clientMac +' was found around ' + location;\n        //  o[c]['clientMac'];\n        // o[c]['location']['lat'];\n        // o[c]['location']['lng'];\n        // o[c]['location']['unc'];\n        // o[c]['seenEpoch'];\n        // map['data']['apFloors'] === null ? \"\" : map['data']['apFloors'].join;\n        // o[c]['manufacturer'];\n        // o[c]['os'];\n        // o[c]['ssid'];\n     \n     \n     \n }\n else{\n client.text = \"Client was not found\";\n}\n }\n}\n// for (var key in result) {\n//   if (result.hasOwnProperty(key)) {\n//     var dev_mac = result[key].mac;\n//     if (dev_mac === ap_mac) {\n//       var dev_name = result[key].name;\n//       client.text = 'Device name: ' + dev_name;\n//   }\n//  }\n// }\nmsg.payload.body = client;\nreturn msg;","outputs":1,"noerr":0,"x":2303.499966621399,"y":1288.0000667572021,"wires":[["1719d2bd.a5666d","8296d7b6.d41fc8"]]},{"id":"1719d2bd.a5666d","type":"debug","z":"76e79b6.be1e864","name":"Function debug","active":true,"console":"false","complete":"true","x":2504.6428594589233,"y":1354.4285221099854,"wires":[]},{"id":"8296d7b6.d41fc8","type":"Spark API","z":"76e79b6.be1e864","profileConfig":"fdebfc7f.8c18f","apiUrl":"http://127.0.0.1:1880/api/cisco_spark_v1.json","resource":"Messages","method":"createMessage","name":"post device name","x":2575.1427698135376,"y":1288.2858037948608,"wires":[["13b40ad1.ea5855"]]},{"id":"13b40ad1.ea5855","type":"debug","z":"76e79b6.be1e864","name":"POST dev name","active":true,"console":"false","complete":"true","x":2742.3570556640625,"y":1373.71435546875,"wires":[]},{"id":"f5162554.28f438","type":"debug","z":"76e79b6.be1e864","name":"CMX GET params","active":true,"console":"false","complete":"true","x":2192.499966621399,"y":1366.0000667572021,"wires":[]},{"id":"75504535.6d075c","type":"inject","z":"76e79b6.be1e864","name":"SJC12 CMX API Call","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":1862.5,"y":1478,"wires":[["b760698b.7f00f8"]]},{"id":"13fbf72c.fa01d9","type":"function","z":"76e79b6.be1e864","name":"Find device name by mac","func":"// This function parses the Meraki Dashboard API response\n// and creates a message to POST to a Spark room.\n// Fill in the roomId & bot_token with your own details\nclient = {}; //reset payload object for clarity\nclient.roomId = 'Y2lzY29zcGFyazovL3VzL1JPT00vNWFkODNlMzAtMDJhNS0xMWU3LWE2YzYtYjljMzEwNjkxM2I0';\nmap = msg.payload;\nmsg.payload = {};\nvar o = map;\n for (var c in o){\n if (o.hasOwnProperty(c)) {\n if (o[c]['macAddress'] === \"50:7b:9d:f0:34:d7\"){\n  clientName = \"yinqwu\";\n  clientMac = o[c]['macAddress'];\n  clientFloor = o[c]['mapInfo']['mapHierarchyString'];\n  client.text = 'Client: ' + clientName + ' with Device ' + clientMac +' was found around ' + clientFloor;\n        //  o[c]['clientMac'];\n        // o[c]['location']['lat'];\n        // o[c]['location']['lng'];\n        // o[c]['location']['unc'];\n        // o[c]['seenEpoch'];\n        // map['data']['apFloors'] === null ? \"\" : map['data']['apFloors'].join;\n        // o[c]['manufacturer'];\n        // o[c]['os'];\n        // o[c]['ssid'];\n     \n     \n     \n }\n else{\n client.text = \"Client was not found\";\n}\n }\n}\n// for (var key in result) {\n//   if (result.hasOwnProperty(key)) {\n//     var dev_mac = result[key].mac;\n//     if (dev_mac === ap_mac) {\n//       var dev_name = result[key].name;\n//       client.text = 'Device name: ' + dev_name;\n//   }\n//  }\n// }\nmsg.payload.body = client;\nreturn msg;","outputs":1,"noerr":0,"x":2304.5,"y":1480,"wires":[["b6595425.b12438","777887a8.80c618"]]},{"id":"b6595425.b12438","type":"debug","z":"76e79b6.be1e864","name":"Function debug","active":true,"console":"false","complete":"true","x":2505.6428928375244,"y":1546.4284553527832,"wires":[]},{"id":"777887a8.80c618","type":"Spark API","z":"76e79b6.be1e864","profileConfig":"fdebfc7f.8c18f","apiUrl":"http://127.0.0.1:1880/api/cisco_spark_v1.json","resource":"Messages","method":"createMessage","name":"post device name","x":2576.1428031921387,"y":1480.2857370376587,"wires":[["2e26b0df.baa27"]]},{"id":"2e26b0df.baa27","type":"debug","z":"76e79b6.be1e864","name":"POST dev name","active":true,"console":"false","complete":"true","x":2743.3570890426636,"y":1565.7142887115479,"wires":[]},{"id":"8cf0eb8b.928238","type":"debug","z":"76e79b6.be1e864","name":"CMX GET params","active":true,"console":"false","complete":"true","x":2193.5,"y":1558,"wires":[]},{"id":"b760698b.7f00f8","type":"http request","z":"76e79b6.be1e864","name":"","method":"GET","ret":"obj","url":"http://10.29.98.242/api/location/v2/clients?macAddress=44:85:00:33:f0:2c","tls":"","x":2083.5,"y":1478,"wires":[["13fbf72c.fa01d9","8cf0eb8b.928238"]]},{"id":"af6fb89f.df1c78","type":"debug","z":"76e79b6.be1e864","name":"Spark API Data","active":true,"console":"false","complete":"true","x":2848.500030517578,"y":354.00000762939453,"wires":[]},{"id":"a33dc8.9ee54238","type":"Spark API","z":"76e79b6.be1e864","profileConfig":"fdebfc7f.8c18f","apiUrl":"http://127.0.0.1:1880/api/cisco_spark_v1.json","resource":"Messages","method":"createMessage","name":"post cmx details","x":2921.500030517578,"y":294.00000762939453,"wires":[["2f827a59.33d2d6"]]},{"id":"2f827a59.33d2d6","type":"debug","z":"76e79b6.be1e864","name":"Spark POST debug","active":true,"console":"false","complete":"true","x":3137.500030517578,"y":294.00000762939453,"wires":[]},{"id":"643f766e.ac0638","type":"switch","z":"76e79b6.be1e864","name":"MAC address match","property":"payload","propertyType":"msg","rules":[{"t":"cont","v":"CC:CC:CC:CC:CC:CC","vt":"str"},{"t":"else"}],"checkall":"false","outputs":2,"x":2350.500030517578,"y":296.00000762939453,"wires":[["a3a7eaba.0c95b8"],["d3504c48.520ae"]]},{"id":"d3504c48.520ae","type":"debug","z":"76e79b6.be1e864","name":"No match","active":true,"console":"false","complete":"true","x":2471.500030517578,"y":356.00000762939453,"wires":[]},{"id":"1611e440.48025c","type":"json","z":"76e79b6.be1e864","name":"","x":2160.500030517578,"y":296.00000762939453,"wires":[["643f766e.ac0638"]]},{"id":"a3a7eaba.0c95b8","type":"json","z":"76e79b6.be1e864","name":"","x":2540.500030517578,"y":294.00000762939453,"wires":[["de10fed8.32804"]]},{"id":"de10fed8.32804","type":"function","z":"76e79b6.be1e864","name":"Spark API Input","func":"// This function parses the CMX data to construct\n// HTTP POST parameters for sending a Spark message to a room\nmap = msg.payload;\nclient = {}; //reset payload object for clarity\nclient.roomId = 'Y2lzY29zcGFyazovL3VzL1JPT00vNWFkODNlMzAtMDJhNS0xMWU3LWE2YzYtYjljMzEwNjkxM2I0';\nif (map['version'] != '2.0'){\n msg.log = \"got post with unexpected version: #{map['version']}\";\n return msg;\n}else{\n msg.log = \"working with correct version\";\n}\nif (map['type'] != 'DevicesSeen'){\nmsg.log = \"got post for event that we're not interested in: #{map['type']}\";\nclient.text ='no new devices was found';\nreturn msg;\n}\nvar o = map['data']['observations'];\nconsole.log('map.data.apMac = '+map.data['apMac']);\n for (var c in o){\n if (o.hasOwnProperty(c)) {\n if (!o[c]['location']){continue}\n console.log('map.data.observations.clientMac = '+o[c]['clientMac']);\n if (o[c]['clientMac'] === \"CC:CC:CC:CC:CC:CC\"){\n  clientMac = o[c]['clientMac'];\n  apMac = map.data['apMac'];\n  lat = o[c]['location']['lat'];\n  lng = o[c]['location']['lng'];\n  seenTime = o[c]['seenTime'];\n  client.text = 'Client: yinqwu with mac address ' + clientMac + ' was detected by AP ' + apMac + '. Client  ' + clientMac +' was found around ' + lat + ',' +  lng + ' at ' + seenTime;\n        //  o[c]['clientMac'];\n        // o[c]['location']['lat'];\n        // o[c]['location']['lng'];\n        // o[c]['location']['unc'];\n        // o[c]['seenEpoch'];\n        // map['data']['apFloors'] === null ? \"\" : map['data']['apFloors'].join;\n        // o[c]['manufacturer'];\n        // o[c]['os'];\n        // o[c]['ssid'];\n     \n     \n     \n }\n }\n}\nmsg.payload.body = client;\nreturn msg;","outputs":"1","noerr":0,"x":2704.500030517578,"y":294.00000762939453,"wires":[["a33dc8.9ee54238","af6fb89f.df1c78"]]},{"id":"f0f7121a.401e9","type":"comment","z":"76e79b6.be1e864","name":"SJC12 CMX","info":"","x":1762.5,"y":1420,"wires":[]},{"id":"4a7cb3a4.80458c","type":"comment","z":"76e79b6.be1e864","name":"MTV CMX","info":"","x":1755,"y":1222.5,"wires":[]},{"id":"7e36d547.15d1fc","type":"comment","z":"76e79b6.be1e864","name":"Meraki CMX","info":"","x":1772.5000228881836,"y":815.0000152587891,"wires":[]},{"id":"7912ca67.bfe464","type":"comment","z":"76e79b6.be1e864","name":"Sample CMX","info":"","x":1800.0000190734863,"y":242.49999904632568,"wires":[]},{"id":"ac1df356.2b4ee","type":"comment","z":"76e79b6.be1e864","name":"Set tracking list","info":"","x":1782.5000267028809,"y":2339.0000343322754,"wires":[]},{"id":"d572f06e.4e925","type":"http in","z":"76e79b6.be1e864","name":"","url":"/update","method":"put","swaggerDoc":"","x":1777.500186920166,"y":2453.000072479248,"wires":[["8c67a515.da2988"]]},{"id":"521dccd7.6bf5b4","type":"mongodb2 in","z":"76e79b6.be1e864","service":"_ext_","configNode":"28e4c639.d5949a","name":"","collection":"trackingList","operation":"update","x":2554.5000648498535,"y":2453.133373260498,"wires":[["e34e47c7.c55598"]]},{"id":"7f3625f7.51f88c","type":"http response","z":"76e79b6.be1e864","name":"","x":2963.5000648498535,"y":2453.7333488464355,"wires":[]},{"id":"90305742.25a298","type":"function","z":"76e79b6.be1e864","name":"update request","func":"\nmsg.result=msg.req.body;\ndelete msg.req.body._id;\nmsg.payload=[\n   msg.payload,\n   msg.req.body\n    ];\nreturn msg;\n\n","outputs":"1","noerr":0,"x":2314.266788482666,"y":2453.3666496276855,"wires":[["521dccd7.6bf5b4"]]},{"id":"8c67a515.da2988","type":"function","z":"76e79b6.be1e864","name":"extract _id","func":"msg._id=msg.payload._id;\nreturn msg;","outputs":1,"noerr":0,"x":1965.3835487365723,"y":2453.7999992370605,"wires":[["e74db85d.e16a38"]]},{"id":"e74db85d.e16a38","type":"objectid","z":"76e79b6.be1e864","name":"","x":2119.383518218994,"y":2453.4667472839355,"wires":[["90305742.25a298"]]},{"id":"eaa3d717.21c4c8","type":"template","z":"76e79b6.be1e864","name":"Web Template","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"<!DOCTYPE html>\n<html lang=\"fr\">\n<head>\n    <title>CMX tracking list</title>\n    <meta charset=\"utf-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\">\n    <link rel=\"stylesheet\" href=\"https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css\">\n    <link rel=\"stylesheet\" href=\"https://cdnjs.cloudflare.com/ajax/libs/bootstrap-timepicker/0.5.2/css/bootstrap-timepicker.min.css\" />\n    <script src=\"https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js\"></script>\n    <script src=\"https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js\"></script>\n    <link type=\"text/css\" rel=\"stylesheet\" href=\"https://cdnjs.cloudflare.com/ajax/libs/jsgrid/1.5.3/jsgrid.min.css\" />\n    <link type=\"text/css\" rel=\"stylesheet\" href=\"https://cdnjs.cloudflare.com/ajax/libs/jsgrid/1.5.3/jsgrid-theme.min.css\" />\n    <script type=\"text/javascript\" src=\"https://cdnjs.cloudflare.com/ajax/libs/jsgrid/1.5.3/jsgrid.min.js\"></script>\n    <script type=\"text/javascript\">\n        $(function () {\n            var db = {{#payload}}{{{.}}}{{/payload}};\n                $(\"#jsgrid\").jsGrid({\n                    width: \"100%\",\n                    inserting: true,\n                    editing: true,\n                    sorting: true,\n                    paging: true,\n\n                    data: db,\n\n                    fields: [\n                        { title:\"name\", name: \"name\", type: \"text\", width: 25 },\n                        { title:\"username\", name: \"username\", type: \"text\", width: 25 },\n                        { title:\"macAddr\", name: \"macAddr\", type: \"text\", width: 50 },\n                        { title:\"ethAddr\", name: \"ethAddr\", type:\"text\", width: 50},\n                        { type: \"control\" }\n                    ],\n               \n                    controller: {\n                        insertItem: function(item) {\n                            return $.ajax({\n                                type: \"POST\",\n                                url: \"/insert\",\n                                data: item\n                            });\n                        },\n                        updateItem: function(item) {\n                           return $.ajax({\n                                type: \"PUT\",\n                                url: \"/update\",\n                                data: item\n                            });\n                        },\n                        deleteItem: function(item) {\n                            return $.ajax({\n                                type: \"DELETE\",\n                                url: \"/delete\",\n                                data: item\n                            });\n                        }\n                    }   \n                });\n            });\n    \n  </script>\n</head>\n<body class=\"container\">\n    <div id=\"masthead\">\n      <div id=\"masthead-content\">\n        <img src=\"https://meraki.cisco.com/img/cisco-meraki.png\"/>\n      </div>\n    </div>\n    <h1>CMX Tracking List</h1>\n    <div id=\"content\">\n    <section class=\"row\">    \n        <div class=\"col-md-6\"></div>\n        <div class=\"col-md-6\" id=\"jsgrid\">\n        </div>\n    </section> \n    </div>\n\n</body>\n</html>\n\n","x":2589.266803741455,"y":2392.599878638983,"wires":[["b10c9e91.d8a69"]]},{"id":"56651198.61028","type":"http in","z":"76e79b6.be1e864","name":"","url":"/trackingList","method":"get","swaggerDoc":"","x":1786.7668190002441,"y":2392.599963992834,"wires":[["9f6b9d7b.4b831"]]},{"id":"b10c9e91.d8a69","type":"http response","z":"76e79b6.be1e864","name":"","x":2770.266803741455,"y":2392.8332160413265,"wires":[]},{"id":"9f6b9d7b.4b831","type":"mongodb2 in","z":"76e79b6.be1e864","service":"_ext_","configNode":"28e4c639.d5949a","name":"","collection":"trackingList","operation":"find.toArray","x":2041.383502960205,"y":2392.299875587225,"wires":[["1d8c922c.8fd39e"]]},{"id":"1d8c922c.8fd39e","type":"json","z":"76e79b6.be1e864","name":"","x":2252.2668838500977,"y":2392.299840927124,"wires":[["9964ce67.9fd11"]]},{"id":"e34e47c7.c55598","type":"function","z":"76e79b6.be1e864","name":"callback response","func":"\nmsg.payload=msg.result;\nreturn msg;","outputs":1,"noerr":0,"x":2787.266788482666,"y":2453.516674041748,"wires":[["7f3625f7.51f88c"]]},{"id":"94cba77.57d3b58","type":"mongodb2 in","z":"76e79b6.be1e864","service":"_ext_","configNode":"28e4c639.d5949a","name":"","collection":"trackingList","operation":"insert","x":2003.8835258483887,"y":2519.4332180023193,"wires":[["667cf2c4.bad61c"]]},{"id":"2435f7ff.f60e88","type":"http response","z":"76e79b6.be1e864","name":"","x":2474.8835258483887,"y":2519.033193588257,"wires":[]},{"id":"4dedec9b.d934b4","type":"http in","z":"76e79b6.be1e864","name":"","url":"/insert","method":"post","swaggerDoc":"","x":1777.2668495178223,"y":2519.250072479248,"wires":[["94cba77.57d3b58"]]},{"id":"ae3546ef.3a86e8","type":"http in","z":"76e79b6.be1e864","name":"","url":"/delete","method":"delete","swaggerDoc":"","x":1787.2668495178223,"y":2580.25004196167,"wires":[["8fd913.da2b66f"]]},{"id":"44bdca34.24eab4","type":"mongodb2 in","z":"76e79b6.be1e864","service":"_ext_","configNode":"28e4c639.d5949a","name":"","collection":"trackingList","operation":"deleteOne","x":2386.8835258483887,"y":2579.799919128418,"wires":[["f4cecf94.2d147"]]},{"id":"8fd913.da2b66f","type":"function","z":"76e79b6.be1e864","name":"extract _id","func":"msg._id=msg.payload._id;\nreturn msg;","outputs":1,"noerr":0,"x":1984.3835182189941,"y":2580.2999687194824,"wires":[["d4476e.cf71389"]]},{"id":"d4476e.cf71389","type":"objectid","z":"76e79b6.be1e864","name":"","x":2156.383487701416,"y":2579.9667167663574,"wires":[["44bdca34.24eab4"]]},{"id":"f4cecf94.2d147","type":"http response","z":"76e79b6.be1e864","name":"","x":2606.7668380737305,"y":2579.3333654403687,"wires":[]},{"id":"667cf2c4.bad61c","type":"function","z":"76e79b6.be1e864","name":"callback response","func":"\nmsg.payload=msg.req.body;\nreturn msg;","outputs":1,"noerr":0,"x":2271.883647918701,"y":2519.2999172210693,"wires":[["2435f7ff.f60e88"]]},{"id":"589de542.1439ec","type":"http in","z":"76e79b6.be1e864","name":"","url":"/clients","method":"get","swaggerDoc":"","x":1792.5000324249268,"y":1732.5000257492065,"wires":[["488a67e5.4f9618"]]},{"id":"be6bdd85.e70d7","type":"http in","z":"76e79b6.be1e864","name":"","url":"/clients/:mac","method":"get","swaggerDoc":"","x":1812.5000324249268,"y":1812.5000257492065,"wires":[["bed1c2ca.69cbb"]]},{"id":"1557cd9.be21832","type":"mongodb2 in","z":"76e79b6.be1e864","service":"_ext_","configNode":"5af52308.7b0b3c","name":"","collection":"cmxmapapi","operation":"findOne","x":2072.5000324249268,"y":1932.5000257492065,"wires":[["706ed06c.f7e02","e54c143c.011f98"]]},{"id":"ef0d96a4.ea1108","type":"mongodb2 in","z":"76e79b6.be1e864","service":"_ext_","configNode":"5af52308.7b0b3c","name":"","collection":"cmxmapapi","operation":"find.toArray","x":2182.5000324249268,"y":1732.5000257492065,"wires":[["eaaa36ed.0e82b8","3fd3116a.69da1e"]]},{"id":"24f79590.ea742a","type":"debug","z":"76e79b6.be1e864","name":"/clients/:mac","active":false,"console":"false","complete":"payload","x":2392.5000324249268,"y":1812.5000257492065,"wires":[]},{"id":"706ed06c.f7e02","type":"debug","z":"76e79b6.be1e864","name":"/clients/:mac - mongodb","active":false,"console":"false","complete":"payload","x":2352.5000324249268,"y":1972.5000257492065,"wires":[]},{"id":"e54c143c.011f98","type":"http response","z":"76e79b6.be1e864","name":"","x":2412.5000324249268,"y":1932.5000257492065,"wires":[]},{"id":"eaaa36ed.0e82b8","type":"http response","z":"76e79b6.be1e864","name":"","x":2412.5000324249268,"y":1732.5000257492065,"wires":[]},{"id":"bed1c2ca.69cbb","type":"function","z":"76e79b6.be1e864","name":"msg.payload=msg.req.params.mac;","func":"//extract mac\nmsg.payload=msg.req.params.mac;\nreturn msg;\n","outputs":1,"noerr":0,"x":2112.5000324249268,"y":1812.5000257492065,"wires":[["24f79590.ea742a","b21b6ca1.05eeb"]]},{"id":"72271a46.867c64","type":"function","z":"76e79b6.be1e864","name":"filter","func":"// This function updates/creates the client in the database\nvar filter = msg.payload;\nif (\"string\" == typeof filter) {\n  filter = JSON.parse(filter);\n}\n\nmsg.payload = [\n    {'name':msg.payload.name},\n    msg.payload,\n    {upsert:true}\n];\n\nreturn msg;\n","outputs":1,"noerr":0,"x":2364.5001068115234,"y":680.0000509619713,"wires":[["906dfda7.94ee5"]]},{"id":"906dfda7.94ee5","type":"mongodb2 in","z":"76e79b6.be1e864","service":"_ext_","configNode":"5af52308.7b0b3c","name":"","collection":"cmxmapapi","operation":"findOneAndUpdate","x":2617.0001068115234,"y":680.5000509619713,"wires":[["2eb601ce.67434e"]]},{"id":"2eb601ce.67434e","type":"debug","z":"76e79b6.be1e864","name":"mongdb insert/update","active":true,"console":"false","complete":"payload","x":2754.500114440918,"y":740.0000509619713,"wires":[]},{"id":"18656189.fe115e","type":"function","z":"76e79b6.be1e864","name":"Format Client","func":"// This function extracts the raw CMX data to create a consistent DB entry\nif(!msg.payload){\n    return null;\n}\n\nmap = msg.payload;\nclient = {}; //reset payload object for clarity\n\nif (map['version'] != '2.0'){\n    msg.log = \"got post with unexpected version: #{map['version']}\";\n    return msg;\n}else{\n    msg.log = \"working with correct version\";\n}\nif (map['type'] != 'DevicesSeen'){\nmsg.log = \"got post for event that we're not interested in: #{map['type']}\";\nreturn msg;\n}\n\nvar o = map['data']['observations'];\nconsole.log('map.data.apMac = '+map.data['apMac']);\n   for (var c in o){\n    if (o.hasOwnProperty(c)) {\n        //console.log(\"Key is \" + c + \", value is \" + o[c].location.lat);\n        if (!o[c]['location']){continue}\n        client.name = o[c]['clientMac'];\n        client.mac = o[c]['clientMac'];\n        client.lat = o[c]['location']['lat'];\n        client.lng = o[c]['location']['lng'];\n        client.unc = o[c]['location']['unc'];\n        client.seenString = o[c]['seenTime'];\n        client.seenEpoch = o[c]['seenEpoch'];\n        client.floors = map['data']['apFloors'] === null ? \"\" : map['data']['apFloors'].join;\n        client.manufacturer = o[c]['manufacturer'];\n        client.os = o[c]['os'];\n        client.ssid = o[c]['ssid'];\n        client.ap = map['data']['apMac'];\n        msg.log = \"AP #{map['data']['apMac']} on #{map['data']['apFloors']}: #{c}\";\n        if (client.seenEpoch===null || client.seenEpoch === 0){continue}//  # This probe is useless, so ignore it\n        \n    }\n    msg.payload = client;\n    node.send(msg);\n   }\n\n   \nreturn msg;","outputs":1,"noerr":0,"x":2184.50008392334,"y":678.1667137145996,"wires":[["121d390f.1d5e97","72271a46.867c64"]]},{"id":"121d390f.1d5e97","type":"debug","z":"76e79b6.be1e864","name":"format client","active":true,"console":"false","complete":"payload","x":2447.000099182129,"y":732.5000509619713,"wires":[]},{"id":"488a67e5.4f9618","type":"function","z":"76e79b6.be1e864","name":"find({})","func":"// Create search for all clients\nmsg.payload = {};\nreturn msg;","outputs":1,"noerr":0,"x":1972.5000324249268,"y":1732.5000257492065,"wires":[["ef0d96a4.ea1108"]]},{"id":"b21b6ca1.05eeb","type":"function","z":"76e79b6.be1e864","name":"msg.payload = {'name':msg.payload};","func":"msg.payload = {'name':msg.payload};\nreturn msg;","outputs":1,"noerr":0,"x":2112.5000324249268,"y":1872.5000257492065,"wires":[["1557cd9.be21832"]]},{"id":"74caf221.2125dc","type":"function","z":"76e79b6.be1e864","name":"CMX Sample Data","func":"msg.payload = {\n    \"version\": \"2.0\",\n    \"secret\": \"supersecret\",\n    \"type\": \"DevicesSeen\",\n    \"data\": {\n        \"apMac\": \"00:18:0a:13:dd:b0\",\n        \"apFloors\": [],\n        \"apTags\": [ \"\", \"home\", \"\" ],\n        \"observations\": [ { \n            \"ipv4\": \"/192.168.0.15\",\n            \"location\": {\n                \"lat\": 36.168684,\n                \"lng\": -115.141706,\n                \"unc\": 1.1185886512767726,\n                \"x\": [], \"y\": [] \n                \n            },\n            \"seenTime\": \"2016-07-29T13:17:10Z\",\n            \"ssid\": \".interwebs\",\n            \"os\": \"Debian-based Linux\",\n            \"clientMac\": \"CC:CC:CC:CC:CC:CC\",\n            \"seenEpoch\": 1469798230,\n            \"rssi\": 48,\n            \"ipv6\": null,\n            \"manufacturer\": \"Edimax Technology\" \n            }, \n            { \n            \"ipv4\": null,\n            \"location\": {\n                \"lat\": 37.410809,\n                \"lng\": -121.929139,\n                \"unc\": 49, \"x\": [],\n                \"y\": []\n                },\n            \"seenTime\": \"2016-07-29T13:17:07Z\",\n            \"ssid\": \"Hotspot-123\",\n            \"os\": \"fancyOS\",\n            \"clientMac\": \"DD:DD:DD:DD:DD:DD\",\n            \"seenEpoch\": 1469798227,\n            \"rssi\": 9,\n            \"ipv6\": null,\n            \"manufacturer\": \"Samsung(THAILAND)\"\n            }\n        ]\n    }\n};\nreturn msg;","outputs":1,"noerr":0,"x":2100.8333435058594,"y":527.5000820159912,"wires":[["18656189.fe115e","20b4d536.e34b9a","1611e440.48025c"]]},{"id":"eded2659.8483c8","type":"inject","z":"76e79b6.be1e864","name":"Sample Client C D","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":1880.8333435058594,"y":527.5000820159912,"wires":[["74caf221.2125dc"]]},{"id":"20b4d536.e34b9a","type":"debug","z":"76e79b6.be1e864","name":"CMX Sample Raw Data","active":true,"console":"false","complete":"payload","x":2407.5000343322754,"y":527.5000381469727,"wires":[]},{"id":"c0df0757.2a62c8","type":"mongodb2 in","z":"76e79b6.be1e864","service":"_ext_","configNode":"5af52308.7b0b3c","name":"","collection":"cmxmapapi","operation":"find.toArray","x":2082.5000324249268,"y":2196.5000257492065,"wires":[["d71c5ce6.e1ca3"]]},{"id":"59eb38e.2b31ac8","type":"inject","z":"76e79b6.be1e864","name":"List all clients","topic":"","payload":"{}","payloadType":"json","repeat":"","crontab":"","once":false,"x":1792.5000324249268,"y":2196.5000257492065,"wires":[["c0df0757.2a62c8"]]},{"id":"d71c5ce6.e1ca3","type":"debug","z":"76e79b6.be1e864","name":"mongo data","active":true,"console":"false","complete":"true","x":2392.5000324249268,"y":2196.5000257492065,"wires":[]},{"id":"a7b39eb6.8fb8a","type":"template","z":"76e79b6.be1e864","name":"CSS","field":"payload.style","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"html, body {\n  margin: 0;\n  padding: 0;\n}\n\nbody {\n  font-family: \"proxima-nova-1\",\"proxima-nova-2\", \"Helvetica Neue\", Helvetica, verdana, sans-serif;\n  -webkit-font-smoothing: antialiased;\n}\n\n#masthead {\n  height: 125px;\n  width: 100%;\n  position: relative;\n  background: #FFFFFF;\n  border-top: 4px solid #78be20;\n  box-shadow: 0 2px 7px rgba(0,0,0,0.2);\n}\n\n#masthead-content {\n  margin: 0 auto;\n  position: relative;\n  width: 80%;\n  height: 100%;\n}\n\n#masthead-content img {\n  float: left;\n  margin: 32px;\n  width: 165px;\n  margin-left: 0;\n}\n\n#content {\n  width: 80%;\n  margin: 60px auto;\n  padding: 40px;\n  box-sizing: border-box;\n  border-radius: 9px;\n  background: #FAFAFA;\n}\n\n#mac-address {\n  margin-bottom: 10px;\n}\n\n#mac-field {\n  width: 30%;\n  height: 35px;\n  margin-bottom: 20px;\n  padding-left: 13px;\n  border: 1px solid #E6E6E6;\n  border-radius: 2px;\n  box-sizing: border-box;\n  font-family: \"proxima-nova-1\",\"proxima-nova-2\", \"Helvetica Neue\", Helvetica, verdana, sans-serif;\n  font-size: 16px;\n  font-weight: 100;\n  min-width: 136px;\n}\n\n#map-wrapper {\n  width: 100%;\n  height: 700px;\n}\n\n#map-canvas {\n  height: 70%;\n  width: 70%;\n}\n\n\nh1 {\n  color: #78be20;\n  font-weight: 100;\n  font-size: 38px;\n  margin-top: 0;\n  letter-spacing: -1px;\n}\n\n\n#last-mac {\n  color: #6B6B6B;\n  width: 100%;\n  font-weight: 400;\n  margin-bottom: 10px;\n  font-size: 14px;\n}\n\n.small {\n  color: #6B6B6B;\n  font-weight: 400;\n  margin-bottom: 30px;\n  font-size: 14px;\n}\n\n.bold {\n  font-weight: 600;\n}\n\nbutton, input {\n  width: 11%;\n}\n\nbutton {\n  height: 35px;\n  border: none;\n  background: #737373;\n  border-radius: 2px;\n  box-sizing: border-box;\n  color: white;\n  font-family: \"proxima-nova-1\",\"proxima-nova-2\", \"Helvetica Neue\", Helvetica, verdana, sans-serif;\n  font-weight: 200;\n  font-size: 14px;\n  padding: 0;\n  min-width: 70px;\n}\n\nbutton:hover{\n  background: #616060;\n}\n","x":2132.5000324249268,"y":2072.5000257492065,"wires":[["69234716.4f5908"]]},{"id":"7db3a9a4.366258","type":"template","z":"76e79b6.be1e864","name":"JavaScript","field":"payload.script","fieldType":"msg","format":"javascript","syntax":"plain","template":"(function ($) {\n  var map,                                      // This is the Google map\n    clientMarker,                               // The current marker when we are following a single client\n    clientUncertaintyCircle,                    // The circle describing that client's location uncertainty\n    lastEvent,                                  // The last scheduled polling task\n    lastInfoWindowMac,                          // The last Mac displayed in a marker tooltip\n    allMarkers = [],                            // The markers when we are in \"View All\" mode\n    lastMac = \"\",                               // The last requested MAC to follow\n    infoWindow = new google.maps.InfoWindow();  // The marker tooltip\n    /*\n    ,\n    markerImage = new google.maps.MarkerImage('blue_circle.png',\n      new google.maps.Size(15, 15),\n      new google.maps.Point(0, 0),\n      new google.maps.Point(4.5, 4.5)\n    );\n    */\n    \n    var latlngbounds = new google.maps.LatLngBounds();\n\n  // Removes all markers\n  function clearAll() {\n    clientMarker.setMap(null);\n    clientUncertaintyCircle.setMap(null);\n    lastInfoWindowMac = \"\";\n    var m;\n    while (allMarkers.length !== 0) {\n      m = allMarkers.pop();\n      if (infoWindow.anchor === m) {\n        lastInfoWindowMac = m.mac;\n      }\n      m.setMap(null);\n    }\n  }\n\n  // Plots the location and uncertainty for a single MAC address\n  function track(client) {\n    clearAll();\n    if (client !== undefined && client.lat !== undefined && !(typeof client.lat === 'undefined')) {\n      var pos = new google.maps.LatLng(client.lat, client.lng);\n      console.log('track client pos '+pos);\n      if (client.manufacturer !== undefined) {\n        mfrStr = client.manufacturer + \" \";\n      } else {\n        mfrStr = \"\";\n      }\n      if (client.os !== undefined) {\n        osStr = \" running \" + client.os;\n      } else {\n        osStr = \"\";\n      }\n      if (client.ssid !== undefined) {\n        ssidStr = \" with SSID '\" + client.ssid + \"'\";\n      } else {\n        ssidStr = \"\";\n      }\n      if (client.floors !== undefined && client.floors !== \"\") {\n        floorStr = \" at '\" + client.floors + \"'\"\n      } else {\n        floorStr = \"\";\n      }\n      $('#last-mac').text(mfrStr + \"'\" + lastMac + \"'\" + osStr + ssidStr +\n        \" last seen on \" + client.seenString + floorStr +\n        \" with uncertainty \" + client.unc.toFixed(1) + \" meters (reloading every 20 seconds)\");\n      map.setCenter(pos);\n      clientMarker.setMap(map);\n      clientMarker.setPosition(pos);\n      clientUncertaintyCircle = new google.maps.Circle({\n        map: map,\n        center: pos,\n        radius: client.unc,\n        fillColor: 'RoyalBlue',\n        fillOpacity: 0.25,\n        strokeColor: 'RoyalBlue',\n        strokeWeight: 1\n      });\n    } else {\n      $('#last-mac').text(\"Client '\" + lastMac + \"' could not be found\");\n    }\n  }\n\n  // Looks up a single MAC address\n  function lookup(mac) {\n    $.getJSON('/clients/' + mac, function (response) {\n      track(response);\n    });\n  }\n\n  // Adds a marker for a single client within the \"view all\" perspective\n  function addMarker(client) {\n    var pos = new google.maps.LatLng(client.lat, client.lng);\n    console.log('addMarker pos '+pos);\n    var m = new google.maps.Marker({\n      position: pos,\n      map: map,\n      mac: client.mac,\n      //icon: markerImage\n    });\n    \n    if(client.lat){\n        latlngbounds.extend(pos);\n        map.fitBounds(latlngbounds);\n    }\n    google.maps.event.addListener(m, 'click', function () {\n        //build info\n        var htmlString = '<h2>Client:  '+client.name +'</h2>';\n        \n        for (var key in client) {\n            if (client.hasOwnProperty(key)) {\n                if(client[key] !== undefined){\n                    if(key == '_id' || key == 'name'){continue}\n                    htmlString += '<p>'+key+' : '+client[key]+'</p>';\n                }\n            }\n        }\n        \n        infoWindow.setContent(\"<div>\" + htmlString + \"</div>\" + \"(<a class='client-filter' href='#' data-mac='\" +\n        client.mac + \"'>Follow this client)</a>\");\n        //\n      //infoWindow.setContent(\"<div>\" + client.mac + \"</div> (<a class='client-filter' href='#' data-mac='\" +\n        //client.mac + \"'>Follow this client)</a>\");\n        \n      infoWindow.open(map, m);\n    });\n    if (client.mac === lastInfoWindowMac) {\n      infoWindow.open(map, m);\n    }\n    allMarkers.push(m);\n  }\n\n  // Displays markers for all clients\n  function trackAll(clients) {\n    clearAll();\n    if (clients.length === 0) {\n      $('#last-mac').text(\"Found no clients (if you just started the web server, you may need to wait a few minutes to receive pushes from Meraki)\");\n    } else { $('#last-mac').text(\"Found \" + clients.length + \" clients (reloading every 20 seconds)\"); }\n    clientUncertaintyCircle.setMap(null);\n    clients.forEach(addMarker);\n  }\n\n  // Looks up all MAC addresses\n  function lookupAll() {\n    $('#last-mac').text(\"Looking up all clients...\");\n    $.getJSON('/clients/', function (response) {\n      trackAll(response);\n    });\n  }\n\n  // Begins a task timer to reload a single MAC every 20 seconds\n  function startLookup() {\n    lastMac = $('#mac-field').val().trim();\n    if (lastEvent !== null) { window.clearInterval(lastEvent); }\n    lookup(lastMac);\n    lastEvent = window.setInterval(lookup, 20000, lastMac);\n  }\n\n  // Begins a task timer to reload all MACs every 20 seconds\n  function startLookupAll() {\n    if (lastEvent !== null) { window.clearInterval(lastEvent); }\n    lastEvent = window.setInterval(lookupAll, 20000);\n    lookupAll();\n  }\n\n  // This is called after the DOM is loaded, so we can safely bind all the\n  // listeners here.\n  function initialize() {\n    var center = new google.maps.LatLng(37.7705, -122.3870);\n    var mapOptions = {\n      zoom: 20,\n      center: center\n    };\n    map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);\n    clientMarker = new google.maps.Marker({\n      position: center,\n      map: null,\n      //icon: markerImage\n    });\n    clientUncertaintyCircle = new google.maps.Circle({\n      position: center,\n      map: null\n    });\n\n    $('#track').click(startLookup).bind(\"enterKey\", startLookup);\n\n    $('#all').click(startLookupAll);\n\n    $(document).on(\"click\", \".client-filter\", function (e) {\n      e.preventDefault();\n      var mac = $(this).data('mac');\n      $('#mac-field').val(mac);\n      startLookup();\n    });\n\n    startLookupAll();\n  }\n\n  // Call the initialize function when the window loads\n  $(window).load(initialize);\n}(jQuery));","x":1972.5000324249268,"y":2072.5000257492065,"wires":[["a7b39eb6.8fb8a"]]},{"id":"733612d9.2d293c","type":"http in","z":"76e79b6.be1e864","name":"","url":"/cmxapimap","method":"get","swaggerDoc":"","x":1802.5000324249268,"y":2072.5000257492065,"wires":[["7db3a9a4.366258"]]},{"id":"634f876e.5e4968","type":"http response","z":"76e79b6.be1e864","name":"","x":2412.5000324249268,"y":2072.5000257492065,"wires":[]},{"id":"69234716.4f5908","type":"template","z":"76e79b6.be1e864","name":"HTML","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"<html>\n  <head>\n    <title>CMX push API demo app with Node-RED</title>\n    <meta name=\"viewport\" content=\"initial-scale=1.0, user-scalable=no\">\n    <meta charset=\"utf-8\">\n    <script>TypekitConfig={kitId:\"hum1oye\",scriptTimeout:1.5e3},function(){var a=document.getElementsByTagName(\"html\")[0];a.className+=\" wf-loading\";var b=setTimeout(function(){a.className=a.className.replace(/(\\s|^)wf-loading(\\s|$)/g,\"\"),a.className+=\" wf-inactive\"},TypekitConfig.scriptTimeout),c=document.createElement(\"script\");c.src=\"//use.typekit.com/\"+TypekitConfig.kitId+\".js\",c.type=\"text/javascript\",c.async=\"true\",c.onload=c.onreadystatechange=function(){var a=this.readyState;if(!a||a==\"complete\"||a==\"loaded\"){clearTimeout(b);try{Typekit.load(TypekitConfig)}catch(c){}}};var d=document.getElementsByTagName(\"script\")[0];d.parentNode.insertBefore(c,d)}()</script>\n    <script src=\"https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false&key=AIzaSyCWFVfLzjGaepofBse9sHFF-S-mtqVjzLA\"></script>\n    <script src=\"http://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.0/jquery.min.js\"></script>\n    <script>{{{payload.script}}}</script>\n    <style>{{{payload.style}}}</style>\n  </head>\n  <body>\n    <div id=\"masthead\">\n      <div id=\"masthead-content\">\n        <img src=\"https://meraki.cisco.com/img/cisco-meraki.png\"/>\n      </div>\n    </div>\n    <div id=\"content\">\n      <h1>CMX API Demo with Node-RED</h1>\n      <div id=\"mac-address\">\n        <input id=\"mac-field\" type=\"text\" placeholder=\"Enter MAC address\" />&nbsp;\n        <button id=\"track\">Follow</button>&nbsp;\n        <button id=\"all\">View All</button>\n        <button><a href=/clients target=\"_blank\" style=\"text-decoration:none; color: inherit\">View All - JSON</a></button>\n      </div>\n      <div id=\"last-mac\"></div>\n      <div class=\"small\"><span class=\"bold\">Clients in the wrong place?</span> Make sure your APs are placed properly in Dashboard.</div>\n      <div id=\"map-wrapper\">\n        <div id=\"map-canvas\"></div>\n      </div>\n    </div>\n  </body>\n</html>","x":2272.5000324249268,"y":2072.5000257492065,"wires":[["634f876e.5e4968"]]},{"id":"3fd3116a.69da1e","type":"debug","z":"76e79b6.be1e864","name":"find({})","active":false,"console":"false","complete":"payload","x":2412.5000324249268,"y":1772.5000257492065,"wires":[]},{"id":"555c6af4.4eed24","type":"comment","z":"76e79b6.be1e864","name":"Client Front-end API","info":"","x":1792.5000324249268,"y":1692.5000257492065,"wires":[]},{"id":"5eec0e04.3e177","type":"comment","z":"76e79b6.be1e864","name":"Utilities","info":"","x":1752.5000324249268,"y":2156.5000257492065,"wires":[]},{"id":"9bf099f1.4e8d18","type":"function","z":"76e79b6.be1e864","name":"CMX Sample Data","func":"msg.payload = {\n    \"version\": \"2.0\",\n    \"secret\": \"supersecret\",\n    \"type\": \"DevicesSeen\",\n    \"data\": {\n        \"apMac\": \"00:18:0a:13:dd:b0\",\n        \"apFloors\": [],\n        \"apTags\": [ \"\", \"home\", \"\" ],\n        \"observations\": [ { \n            \"ipv4\": \"/192.168.0.15\",\n            \"location\": {\n                \"lat\": 34.010990,\n                \"lng\": -118.488502,\n                \"unc\": 1.2185886512767726,\n                \"x\": [], \"y\": [] \n                \n            },\n            \"seenTime\": \"2016-07-29T13:17:10Z\",\n            \"ssid\": \".interwebs\",\n            \"os\": \"Debian-based Linux\",\n            \"clientMac\": \"AA:AA:AA:AA:AA:AA\",\n            \"seenEpoch\": 1469795230,\n            \"rssi\": 48,\n            \"ipv6\": null,\n            \"manufacturer\": \"Edimax Technology\" \n            }, \n            { \n            \"ipv4\": null,\n            \"location\": {\n                \"lat\": 37.810503,\n                \"lng\": -122.417119,\n                \"unc\": 49, \"x\": [],\n                \"y\": []\n                },\n            \"seenTime\": \"2016-07-29T13:17:07Z\",\n            \"ssid\": null,\n            \"os\": null,\n            \"clientMac\": \"BB:BB:BB:BB:BB:BB\",\n            \"seenEpoch\": 1469598227,\n            \"rssi\": 9,\n            \"ipv6\": null,\n            \"manufacturer\": \"Samsung(THAILAND)\"\n            }\n        ]\n    }\n};\nreturn msg;","outputs":1,"noerr":0,"x":2100.8333435058594,"y":487.5000820159912,"wires":[["18656189.fe115e","1611e440.48025c"]]},{"id":"d3060944.67fe08","type":"inject","z":"76e79b6.be1e864","name":"Sample Client A B","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":1880.8333435058594,"y":487.5000820159912,"wires":[["9bf099f1.4e8d18"]]},{"id":"c1d54e63.69193","type":"comment","z":"76e79b6.be1e864","name":"Client Front-end Site","info":"","x":1792.5000324249268,"y":2032.5000257492065,"wires":[]},{"id":"3c1da4c7.f74f0c","type":"inject","z":"76e79b6.be1e864","name":"DELETE ALL DATA","topic":"","payload":"{}","payloadType":"json","repeat":"","crontab":"","once":false,"x":1812.5000324249268,"y":2241.5000257492065,"wires":[["9d019461.888708"]]},{"id":"9d019461.888708","type":"mongodb2 in","z":"76e79b6.be1e864","service":"_ext_","configNode":"5af52308.7b0b3c","name":"","collection":"cmxmapapi","operation":"remove","x":2072.5000324249268,"y":2241.5000257492065,"wires":[["ee859160.ef084"]]},{"id":"ee859160.ef084","type":"debug","z":"76e79b6.be1e864","name":"delete mongo data","active":true,"console":"false","complete":"true","x":2412.5000324249268,"y":2241.5000257492065,"wires":[]},{"id":"9964ce67.9fd11","type":"template","z":"76e79b6.be1e864","name":"CSS","field":"payload.style","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"html, body {\n  margin: 50px;\n  padding: 0;\n}\n\nbody {\n  font-family: \"proxima-nova-1\",\"proxima-nova-2\", \"Helvetica Neue\", Helvetica, verdana, sans-serif;\n  -webkit-font-smoothing: antialiased;\n}\n\n#masthead {\n  height: 100px;\n  width: 100%;\n  position: relative;\n  background: #FFFFFF;\n  border-top: 4px solid #78be20;\n  box-shadow: 0 2px 7px rgba(0,0,0,0.2);\n}\n\n#masthead-content {\n  margin: 0 auto;\n  position: relative;\n  width: 80%;\n  height: 100%;\n}\n\n#masthead-content img {\n  float: left;\n  margin: 32px;\n  width: 165px;\n  margin-left: 0;\n}\n\n#content {\n  width: 80%;\n  margin: 60px auto;\n  padding: 40px;\n  box-sizing: border-box;\n  border-radius: 9px;\n  background: #FAFAFA;\n}\n\n\nh1 {\n  color: #62E559;\n  font-weight: 100;\n  font-size: 38px;\n  margin-top: 20px;\n  margin-bottom: 20px;\n  letter-spacing: -1px;\n}\n\n\n\n.small {\n  color: #6B6B6B;\n  font-weight: 400;\n  margin-bottom: 30px;\n  font-size: 14px;\n}\n\n.bold {\n  font-weight: 600;\n}\n\n","x":2407,"y":2392,"wires":[["eaa3d717.21c4c8"]]},{"id":"6d7c369c.27e538","type":"comment","z":"76e79b6.be1e864","name":"README","info":"#CMX Demo \nThis Flow is an example of how to use the Cisco Meraki CMX\nJSON feed to store clients into a database, track them\non a Google map and send a notification to Spark room.\n\n\nThere are five major components\n- CMX Receiver\n- Front-end API\n- Front-end Website (Google MAP)\n- Front-end MongoDB (Tracking List)\n- Spark room\n\n\n##CMX Receiver -\nThere are 4 types of CMX data can be feeded into the flow\n- Sample CMX data\n- Meraki CMX Location and scanning data\n- Meraki CMX Dashboard API\n- Cisco Prod CMX API\n\nThere are two Sample Clients data that can be used to test the flow.\n\nThe CMX Listener utilizes the Node-RED CMX node to collect\nJSON data from a Cisco Meraki network. This feed is generally\nupdated within 2 minutes. \n\nOnce the data has been received, the JSON is parsed and\ncommitted to a MongoDB. Please ensure your MongoDB is running\nfor this flow to work properly.\n\n\n##Front-end API - \nThere are two [GET] HTTP routes that provide access to the \ncollected client data. These will be used by the front-end \nwebsite to pull the client information for all or specific\nclients. Fun Fact: You can also use these routes with Postman\nor a standard browser to pull the data directly.\n\n##Front-end Website - \nThis will provide the webpage to view the Google map and \ntrack clients.\nThe website can be viewed at\n`http://yourserver:1880/cmxapimap`\n\n#spark room -\nThe flow will parses the CMX data and \nposts the matching clients into a Spark room.\n\n\n\n\n#Pre-requisities\n\nNodeJS: https://nodejs.org/en/download/\nNodeRed: https://nodered.org/docs/getting-started/installation\nCMX receiver node: https://flows.nodered.org/node/node-red-contrib-meraki-cmx\nSpark node: https://flows.nodered.org/node/node-red-contrib-spark\nHttps node: https://flows.nodered.org/node/node-red-contrib-https\nMongodb2 node: https://flows.nodered.org/node/node-red-contrib-mongodb2\nObjectid node: https://flows.nodered.org/node/node-red-contrib-objectid\n\n\n#Setup\n- Configure a Cisco Meraki network to post the CMX JSON to\nyour listening URL. Example: `http://yourserver:1880/cmx`\n\n- Install and configure MongoDB. Then update the MongoDB2 \nnodes within your flow to match the appropriate settings.\nExample: `mongodb://localhost:27017/test`\n\n- Configure the Spark node by changing the bearer token and room ID\n\n- Insert Sample Client information by pressing the blue\nbuttons for each. \n\n","x":2396.66650390625,"y":106.66666412353516,"wires":[]},{"id":"fdebfc7f.8c18f","type":"Spark Authentication","z":"76e79b6.be1e864","name":"CMX Bot"},{"id":"21825d46.ffa242","type":"meraki-cmx-settings","z":"76e79b6.be1e864","name":"CMX"},{"id":"28e4c639.d5949a","type":"mongodb2","z":"76e79b6.be1e864","uri":"mongodb://localhost:27017/test","name":"test","options":"","parallelism":"-1"},{"id":"5af52308.7b0b3c","type":"mongodb2","z":"76e79b6.be1e864","uri":"mongodb://localhost:27017/test","name":"test","options":"","parallelism":"-1"}]
```
